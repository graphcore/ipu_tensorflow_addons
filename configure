#!/bin/bash

set -e # Stop on error

DEFAULT_VENV_PATH="./venv"
USER_BAZELRC=true

DIR=$(realpath $(dirname $0))
cd $DIR

print_usage_and_exit() {
  cat <<EOM
Usage: $0 TENSORFLOW-WHEEL-PATH [--help|-h] [--venv-path VENV-PATH] [--no-user-bazelrc] [--environment-variables VARIABLES] [--disk-cache|-c CACHE-FOLDER]

  TENSORFLOW-WHEEL-PATH
      The path to the IPU TensorFlow .whl file you want to build IPU TensorFlow Addons for.
  -h, --help
      Print this help message.
  --venv-path VENV-PATH
      Choose the location of the Python virtual environment.
      If a virtual environment already exists at the specified path, it will be reused.
      The default is $DEFAULT_VENV_PATH.
  --no-user-bazelrc
      Do not touch .bazelrc.user
      Important: This means the environment will not be frozen.
  --environment-variables VARIABLES
      Comma separated list of environment variables to forward to Bazel.
  -c, --disk-cache CACHE-FOLDER
      Enable bazel's disk cache.
EOM
  exit 1
}

POSITIONAL_ARGS=""

# Parse non-positional args
while [[ $# -gt 0 ]]; do
  case "$1" in
  --venv-path)
    shift
    VENV_PATH=$1
    if [[ ${VENV_PATH:0:1} == "-" ]]; then
      echo "ERROR: invalid ---venv-path argument: path cannot start with a '-': ${VENV_PATH}"
      exit 1
    fi
    shift
    ;;
  --no-user-bazelrc)
    USER_BAZELRC=false
    shift
    ;;
  --environment-variables)
    shift
    ENV_VARS=$1
    if [[ ${ENV_VARS:0:1} == "-" ]]; then
      echo "ERROR: invalid --environment-variables argument: variables cannot start with a '-': ${ENV_VARS}"
      exit 1
    fi
    shift
    ;;
  -c | --disk-cache)
    shift
    BAZEL_CACHE_DIR=$1
    if [[ ${BAZEL_CACHE_DIR:0:1} == "-" ]]; then
      echo "ERROR: invalid --disk-cache argument: folder cannot start with a '-': ${BAZEL_CACHE_DIR}"
      exit 1
    fi
    shift
    ;;
  -h | --help)
    print_usage_and_exit
    shift
    ;;
  *)
    POSITIONAL_ARGS="$POSITIONAL_ARGS $1"
    shift
    ;;
  esac
done

# Parse positional args
eval set -- "$POSITIONAL_ARGS"

if [[ "$#" -ne 1 ]]
	then
	  echo "ERROR: incorrect or missing parameters"
    print_usage_and_exit
fi

TENSORFLOW_WHEEL_PATH=$1

if [ ! -z "${TF_POPLAR_BASE}" ] && [ ! -z "${TF_POPLAR_SANDBOX}" ]; then
  echo "ERROR: Both TF_POPLAR_BASE and TF_POPLAR_SANDBOX are set, please unset one"
  exit 1
fi
if command -v popc &> /dev/null; then
  # If Poplar is already in you PATH, that would take precedence over TF_POPLAR_BASE or TF_POPLAR_SANDBOX.
  if [ -n "${TF_POPLAR_BASE}" ]; then
    echo "ERROR: TF_POPLAR_BASE is set but Poplar is already in your PATH"
    exit 1
  elif [ -n "${TF_POPLAR_SANDBOX}" ]; then
    echo "ERROR: TF_POPLAR_SANDBOX is set but Poplar is already in your PATH"
    exit 1
  fi
elif [ ! -z "${TF_POPLAR_BASE}" ]; then
  if [ -f "${TF_POPLAR_BASE}/bin/popc" ]; then
    echo "OK: TF_POPLAR_BASE is set to $TF_POPLAR_BASE"
    # Add Poplar to PATH.
    source ${TF_POPLAR_BASE}/enable.sh
  else
    echo "ERROR: TF_POPLAR_BASE is set to an invalid path: ${TF_POPLAR_BASE}/bin/popc doesn't exist"
    exit 1
  fi
elif [ ! -z "${TF_POPLAR_SANDBOX}" ]; then
  if [ -f "${TF_POPLAR_SANDBOX}/poplar/bin/popc" ]; then
    echo "OK: TF_POPLAR_SANDBOX is set to $TF_POPLAR_SANDBOX"
    # Add Poplar to PATH.
    source ${TF_POPLAR_SANDBOX}/poplar/enable.sh
  else
    echo "ERROR: TF_POPLAR_SANDBOX is set to an invalid path: ${TF_POPLAR_SANDBOX}/poplar/bin/popc doesn't exist"
    exit 1
  fi
else
  echo "ERROR: You need to add Poplar to your PATH, or set either TF_POPLAR_BASE or TF_POPLAR_SANDBOX"
  exit 1
fi

# On macOS, use the Python from Homebrew if installed.
if [[ $OSTYPE == darwin* ]] && [ -x "$(command -v brew)" ]; then
  PYTHON_BIN_PATH=$(brew list ${python@3} | grep "python$" | head -n 1)
fi

if [ -z ${PYTHON_BIN_PATH} ]; then
  PYTHON_BIN_PATH=$(which python3)
fi

if [ -z ${PYTHON_BIN_PATH} ]; then
  echo "Couldn't find Python interpreter"
  exit 1
fi

echo "Using ${PYTHON_BIN_PATH}"

VE="${VENV_PATH:-$DEFAULT_VENV_PATH}"

if [ -d "${VE}" ]; then
  echo "Re-using existing ${VE} virtual environment"
else
  echo "Creating Python virtual environment in ${VE}"
  # Set up an independent python virtualenv.
  USE_VIRTUALENV=1
  rm -rf ${VE}
  ${PYTHON_BIN_PATH} -m venv ${VE} --without-pip
fi

# Activate the venv.
# It's important that we're still in the venv later when we create .bazelrc.user
source ${VE}/bin/activate

# Install the latest pip.
wget https://bootstrap.pypa.io/get-pip.py
python3 get-pip.py
rm -f get-pip.py

# Install latest setuptools.
pip install --upgrade setuptools wheel

# Install supplied tensorflow wheel.
pip install --force-reinstall ${TENSORFLOW_WHEEL_PATH}

# Create user config.
if [ "$USER_BAZELRC" = true ]; then
  tmp_backup=$(mktemp)
  # Backup current user config if it exists.
  if [ -f ".bazelrc.user" ]; then
    mv .bazelrc.user $tmp_backup
  fi

  # Paths pointing to venv, Poplar, and TensorFlow.
  echo "build --test_env=PATH=${PATH}" >>.bazelrc.user
  echo "build --test_env=LD_LIBRARY_PATH=${LD_LIBRARY_PATH}" >>.bazelrc.user
  echo "build --test_env=PYTHONPATH=${PYTHONPATH}" >>.bazelrc.user

  if [ -n "${TMPDIR+set}" ]; then
    echo "build --action_env=TMPDIR=${TMPDIR}" >>.bazelrc.user
  fi
  if [ -n "${ENV_VARS+set}" ]; then
    for v in $(echo $ENV_VARS | tr "," "\n"); do
      echo "build --action_env=$v=${!v}" >>.bazelrc.user
    done
  fi

  if [ -n "${BAZEL_CACHE_DIR+set}" ]; then
    echo "build --disk_cache=${BAZEL_CACHE_DIR}" >>.bazelrc.user
  fi

  # Restore the user defined options.
  separation="### ADD USER DEFINED OPTIONS AFTER THIS LINE ONLY ###"
  echo $separation >>.bazelrc.user
  if [ -f "$tmp_backup" ]; then
    sed "0,/$separation/d" $tmp_backup >>.bazelrc.user
    rm $tmp_backup
  fi
  echo "Successfully created .bazelrc.user"
fi
